name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®æƒé™ä»¥ä¾¿æŽ¨é€åˆ° gh-pages åˆ†æ”¯
permissions:
  contents: write
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªéƒ¨ç½²åŒæ—¶è¿è¡Œï¼Œä½†ä¸å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¿è¡Œ
concurrency:
  group: github-pages
  cancel-in-progress: false

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´çš„ git åŽ†å²
      
      - name: Load versions
        run: cat .github/workflows/versions.env >> $GITHUB_ENV
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Setup Rust
        uses: moonrepo/setup-rust@v1
        with:
          cache: true
      
      - name: Add Rust nightly components
        run: rustup component add rust-src --toolchain nightly-x86_64-unknown-linux-gnu
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y yq cargo
      
      - name: Prepare Web (vodozemac)
        run: |
          chmod +x ./scripts/prepare-web.sh
          ./scripts/prepare-web.sh
      
      - name: Remove vodozemac .gitignore
        run: rm -f ./assets/vodozemac/.gitignore
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Analyze code
        run: flutter analyze --no-fatal-infos
        continue-on-error: true  # åˆ†æžå¤±è´¥ä¸å½±å“æž„å»º
      
      - name: Run tests
        run: flutter test
        continue-on-error: true  # æµ‹è¯•å¤±è´¥ä¸å½±å“æž„å»º
      
      - name: Build Web Release
        run: |
          flutter build web \
            --release \
            --web-renderer canvaskit \
            --dart-define=FLUTTER_WEB_CANVASKIT_URL=canvaskit/ \
            --source-maps \
            --no-wasm-dry-run \
            --base-href="/"
      
      - name: Prepare deployment directory
        run: |
          mkdir -p deploy
          cp -r build/web/* deploy/
          
          # åˆ›å»º .nojekyll æ–‡ä»¶ä»¥é˜²æ­¢ GitHub Pages ä½¿ç”¨ Jekyll
          touch deploy/.nojekyll
          
          # åˆ›å»º CNAME æ–‡ä»¶ï¼ˆå¦‚æžœä½ æœ‰è‡ªå®šä¹‰åŸŸåï¼Œè¯·å–æ¶ˆæ³¨é‡Šå¹¶ä¿®æ”¹ï¼‰
          # echo "your-domain.com" > deploy/CNAME
          
          # æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯
          echo "Build: $(date '+%Y-%m-%d %H:%M:%S')" > deploy/BUILD_INFO.txt
          echo "Commit: $(git rev-parse --short HEAD)" >> deploy/BUILD_INFO.txt
          echo "Branch: $(git rev-parse --abbrev-ref HEAD)" >> deploy/BUILD_INFO.txt
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨å†…ç½® token
          publish_dir: ./deploy
          publish_branch: gh-pages
          force_orphan: true  # æ¯æ¬¡æŽ¨é€åˆ›å»ºä¸€ä¸ªæ–°çš„æäº¤åŽ†å²
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: |
            Deploy FluffyChat to GitHub Pages
            
            Source commit: ${{ github.sha }}
            Build date: $(date '+%Y-%m-%d %H:%M:%S')
      
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ¿ **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Pages URL:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ **Build Time:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
