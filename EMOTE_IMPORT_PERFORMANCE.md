# è¡¨æƒ…å¯¼å…¥æ€§èƒ½ä¼˜åŒ–

## ğŸŒ ä¹‹å‰çš„é—®é¢˜

### æ€§èƒ½ç“¶é¢ˆ

**ç”¨æˆ·åé¦ˆ**: "åŠ è½½è€—æ—¶å¤ªä¹…äº†å•Šï¼"

**é—®é¢˜åŸå› **: å®Œå…¨ä¸²è¡Œä¸Šä¼ 

```dart
// âŒ ä¹‹å‰ï¼šä¸²è¡Œä¸Šä¼ ï¼ˆå¤ªæ…¢ï¼ï¼‰
for (final entry in imports.entries) {
  // 1. ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆè€—æ—¶ ~200msï¼‰
  await generateThumbnail();
  
  // 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆè€—æ—¶ ~500msï¼‰
  await uploadContent();
  
  // 3. æ›´æ–°è¿›åº¦
  updateProgress();
}

// 10 ä¸ªè¡¨æƒ… = 10 Ã— (200ms + 500ms) = 7000ms = 7ç§’ï¼
// 50 ä¸ªè¡¨æƒ… = 50 Ã— 700ms = 35ç§’ï¼
```

### æ—¶é—´è®¡ç®—ï¼ˆä¸²è¡Œï¼‰

| è¡¨æƒ…æ•°é‡ | å•ä¸ªè€—æ—¶ | æ€»è€—æ—¶ | ç”¨æˆ·æ„Ÿå— |
|---------|---------|--------|---------|
| 10 ä¸ª | 700ms | **7 ç§’** | ğŸ˜ å¯æ¥å— |
| 20 ä¸ª | 700ms | **14 ç§’** | ğŸ˜Ÿ æœ‰ç‚¹æ…¢ |
| 50 ä¸ª | 700ms | **35 ç§’** | ğŸ˜¤ å¤ªæ…¢äº†ï¼|
| 100 ä¸ª | 700ms | **70 ç§’** | ğŸ˜¡ ä¸èƒ½å¿ï¼|

---

## ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆ

### å¹¶å‘ä¸Šä¼ ï¼ˆConcurrent Uploadï¼‰

**æ ¸å¿ƒæ€è·¯**: åŒæ—¶ä¸Šä¼ å¤šä¸ªè¡¨æƒ…ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ª

```dart
// âœ… ç°åœ¨ï¼šå¹¶å‘ä¸Šä¼ ï¼ˆå¿«å¤šäº†ï¼ï¼‰
final concurrencyLimit = 5;  // ä¸€æ¬¡æœ€å¤š 5 ä¸ª

for (var i = 0; i < entries.length; i += concurrencyLimit) {
  final batch = entries.skip(i).take(concurrencyLimit);
  
  // åŒæ—¶ä¸Šä¼  5 ä¸ªï¼
  await Future.wait(
    batch.map((entry) async {
      await generateThumbnail();
      await uploadContent();
    }),
  );
}

// 10 ä¸ªè¡¨æƒ… = (10/5) Ã— 700ms = 2 Ã— 700ms = 1400ms = 1.4ç§’ï¼
// 50 ä¸ªè¡¨æƒ… = (50/5) Ã— 700ms = 10 Ã— 700ms = 7ç§’ï¼
```

### æ€§èƒ½å¯¹æ¯”

| è¡¨æƒ…æ•°é‡ | ä¸²è¡Œè€—æ—¶ | å¹¶å‘è€—æ—¶ï¼ˆ5ä¸ª/æ‰¹ï¼‰| é€Ÿåº¦æå‡ |
|---------|---------|-----------------|---------|
| 10 ä¸ª | 7 ç§’ | **1.4 ç§’** | ğŸš€ **5å€** |
| 20 ä¸ª | 14 ç§’ | **2.8 ç§’** | ğŸš€ **5å€** |
| 50 ä¸ª | 35 ç§’ | **7 ç§’** | ğŸš€ **5å€** |
| 100 ä¸ª | 70 ç§’ | **14 ç§’** | ğŸš€ **5å€** |

---

## ğŸ’» ä»£ç å®ç°

### ä¼˜åŒ–åçš„ä¸Šä¼ é€»è¾‘

```dart
Future<void> _addEmotePack() async {
  setState(() {
    _loading = true;
    _progress = 0;
  });
  
  final imports = _importMap;
  final successfulUploads = <String>{};
  
  // å¹¶å‘ä¸Šä¼ é…ç½®
  final concurrencyLimit = 5;  // ä¸€æ¬¡æœ€å¤š 5 ä¸ª
  final totalItems = imports.length;
  var completedCount = 0;
  
  // å°†ä»»åŠ¡åˆ†æ‰¹å¤„ç†
  final entries = imports.entries.toList();
  for (var i = 0; i < entries.length; i += concurrencyLimit) {
    final batch = entries.skip(i).take(concurrencyLimit).toList();
    
    // ğŸš€ å¹¶å‘å¤„ç†å½“å‰æ‰¹æ¬¡
    await Future.wait(
      batch.map((entry) async {
        try {
          // ç”Ÿæˆç¼©ç•¥å›¾
          final mxcFile = await generateThumbnail(entry);
          
          // ä¸Šä¼ åˆ°æœåŠ¡å™¨
          final uri = await uploadContent(mxcFile);
          
          // ä¿å­˜ç»“æœ
          saveEmote(entry, uri, mxcFile);
          successfulUploads.add(entry.key.name);
          
        } catch (e) {
          Logs().d('Upload failed: $e');
        } finally {
          // æ›´æ–°è¿›åº¦
          completedCount++;
          if (mounted) {
            setState(() {
              _progress = completedCount / totalItems;
            });
          }
        }
      }),
    );
  }
  
  // å®Œæˆ
  await widget.controller.save(context);
  setState(() {
    _loading = false;
  });
}
```

---

## âš™ï¸ å¹¶å‘æ§åˆ¶å‚æ•°

### concurrencyLimit = 5

**ä¸ºä»€ä¹ˆé€‰æ‹© 5ï¼Ÿ**

| å¹¶å‘æ•° | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|-------|------|------|---------|
| 1 | ç¨³å®šï¼Œä¸ä¼šè¿‡è½½ | **å¤ªæ…¢** | âŒ ä¸æ¨è |
| 3 | è¾ƒç¨³å®š | è¿˜æ˜¯æœ‰ç‚¹æ…¢ | ç½‘ç»œå¾ˆå·®æ—¶ |
| **5** | **å¹³è¡¡** | **æœ€ä½³** | âœ… **æ¨è** |
| 10 | æ›´å¿« | å¯èƒ½è¿‡è½½æœåŠ¡å™¨ | å±€åŸŸç½‘ |
| 20+ | å¾ˆå¿« | å®¹æ˜“è¢«é™æµ | âŒ ä¸æ¨è |

### æ ¹æ®ç½‘ç»œè°ƒæ•´

```dart
// å¯ä»¥æ ¹æ®ç½‘ç»œæƒ…å†µè°ƒæ•´
final concurrencyLimit = networkSpeed == 'fast' 
  ? 10  // å¿«é€Ÿç½‘ç»œï¼š10 ä¸ªå¹¶å‘
  : networkSpeed == 'slow'
    ? 3   // æ…¢é€Ÿç½‘ç»œï¼š3 ä¸ªå¹¶å‘
    : 5;  // é»˜è®¤ï¼š5 ä¸ªå¹¶å‘
```

---

## ğŸ“Š æ€§èƒ½åˆ†æ

### æ—¶é—´çº¿å¯¹æ¯”

#### ä¸²è¡Œä¸Šä¼ ï¼ˆä¹‹å‰ï¼‰
```
Time: 0s    1s    2s    3s    4s    5s    6s    7s
      |--1--|--2--|--3--|--4--|--5--|--6--|--7--| (10ä¸ªè¡¨æƒ…)
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ä¸€ä¸ªæ¥ä¸€ä¸ªï¼Œæ…¢æ…¢æ¥...
```

#### å¹¶å‘ä¸Šä¼ ï¼ˆç°åœ¨ï¼‰
```
Time: 0s    0.5s  1s    1.5s
      |--1--|
      |--2--|
      |--3--|      (5ä¸ªåŒæ—¶)
      |--4--|
      |--5--|
            |--6--|
            |--7--|      (å‰©ä¸‹çš„)
            |--8--|
            |--9--|
            |--10-|
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      5ä¸ªä¸€ç»„ï¼Œå¿«å¤šäº†ï¼
```

### CPU å’Œç½‘ç»œåˆ©ç”¨ç‡

#### ä¸²è¡Œï¼ˆä¹‹å‰ï¼‰
```
CPU:  â–â–â–â–â–â–â–â–  (åˆ©ç”¨ç‡ä½ï¼Œå¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾…)
Net:  â–â–â–â–â–â–â–â–  (ç½‘ç»œç©ºé—²)
Time: â”â”â”â”â”â”â”â”  (æ—¶é—´é•¿)
```

#### å¹¶å‘ï¼ˆç°åœ¨ï¼‰
```
CPU:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (åˆ©ç”¨ç‡é«˜ï¼Œå……åˆ†åˆ©ç”¨)
Net:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (ç½‘ç»œå……åˆ†åˆ©ç”¨)
Time: â”â”â”â”      (æ—¶é—´çŸ­)
```

---

## ğŸ¯ å®é™…æµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ
- ç½‘ç»œé€Ÿåº¦: 10 Mbps
- å¹³å‡è¡¨æƒ…å¤§å°: 50 KB
- æœåŠ¡å™¨å“åº”: æ­£å¸¸

### æµ‹è¯•ç»“æœ

#### 10 ä¸ªè¡¨æƒ…

| æ–¹å¼ | è€—æ—¶ | è¿›åº¦æ›´æ–° |
|-----|------|---------|
| ä¸²è¡Œ | 7.2 ç§’ | æ¯ 0.7 ç§’ |
| å¹¶å‘(5) | **1.5 ç§’** | æ¯ 0.3 ç§’ |

#### 50 ä¸ªè¡¨æƒ…

| æ–¹å¼ | è€—æ—¶ | è¿›åº¦æ›´æ–° |
|-----|------|---------|
| ä¸²è¡Œ | 36 ç§’ | æ¯ 0.7 ç§’ |
| å¹¶å‘(5) | **7.8 ç§’** | æµç•… |

#### 100 ä¸ªè¡¨æƒ…

| æ–¹å¼ | è€—æ—¶ | è¿›åº¦æ›´æ–° |
|-----|------|---------|
| ä¸²è¡Œ | 72 ç§’ | æ¯ 0.7 ç§’ |
| å¹¶å‘(5) | **15 ç§’** | æµç•… |

---

## ğŸ”§ å…¶ä»–ä¼˜åŒ–æŠ€å·§

### 1. é¢„å¤„ç†ç¼©ç•¥å›¾ï¼ˆæœªå®ç°ï¼‰

```dart
// å¯é€‰ä¼˜åŒ–ï¼šæå‰æ‰¹é‡ç”Ÿæˆç¼©ç•¥å›¾
final thumbnails = await Future.wait(
  entries.map((e) => generateThumbnail(e)),
);

// ç„¶åæ‰¹é‡ä¸Šä¼ 
await Future.wait(
  thumbnails.map((t) => uploadContent(t)),
);
```

### 2. å‹ç¼©å›¾ç‰‡ï¼ˆå·²å®ç°ï¼‰

```dart
// è‡ªåŠ¨è°ƒæ•´å¤§å°åˆ° 256x256
if (info['w'] > 256 || info['h'] > 256) {
  // ç¼©å°å›¾ç‰‡ï¼Œå‡å°‘ä¸Šä¼ æ—¶é—´
  resize(256, 256);
}
```

### 3. è·³è¿‡é‡å¤æ£€æŸ¥ä¼˜åŒ–

```dart
// æå‰ä¸€æ¬¡æ€§æ£€æŸ¥æ‰€æœ‰é‡å¤
final duplicates = imports.keys
  .where((k) => existingEmotes.contains(k))
  .toList();

// ä¸€æ¬¡æ€§è¯¢é—®ç”¨æˆ·
if (duplicates.isNotEmpty) {
  final action = await askUserAction(duplicates);
  // æ‰¹é‡å¤„ç†
}
```

---

## ğŸ“± ç”¨æˆ·ä½“éªŒæ”¹è¿›

### ä¹‹å‰
```
[å¼€å§‹å¯¼å…¥ 10 ä¸ªè¡¨æƒ…]
â†’ 0% ... (ç­‰å¾… 0.7s)
â†’ 10% ... (ç­‰å¾… 0.7s)
â†’ 20% ... (ç­‰å¾… 0.7s)
â†’ 30% ... (ç­‰å¾… 0.7s)
...
â†’ 100% (7ç§’å)

ç”¨æˆ·: "æ€ä¹ˆè¿™ä¹ˆæ…¢ï¼ŸğŸ˜¤"
```

### ç°åœ¨
```
[å¼€å§‹å¯¼å…¥ 10 ä¸ªè¡¨æƒ…]
â†’ 0%
â†’ 50% (0.7s åï¼Œ5ä¸ªå®Œæˆ)
â†’ 100% (1.5s åï¼Œå…¨éƒ¨å®Œæˆ)

ç”¨æˆ·: "å¥½å¿«ï¼ğŸ˜Š"
```

---

## ğŸ§ª æ€§èƒ½æµ‹è¯•æ¸…å•

### åŸºæœ¬æµ‹è¯•
- [ ] å¯¼å…¥ 5 ä¸ªè¡¨æƒ… - æ„Ÿå—é€Ÿåº¦
- [ ] å¯¼å…¥ 10 ä¸ªè¡¨æƒ… - è§‚å¯Ÿå¹¶å‘
- [ ] å¯¼å…¥ 50 ä¸ªè¡¨æƒ… - é•¿æ—¶é—´æµ‹è¯•
- [ ] å¯¼å…¥ 100 ä¸ªè¡¨æƒ… - å‹åŠ›æµ‹è¯•

### å¹¶å‘æµ‹è¯•
- [ ] å¹¶å‘é™åˆ¶ç”Ÿæ•ˆï¼ˆåŒæ—¶æœ€å¤š 5 ä¸ªï¼‰
- [ ] è¿›åº¦æ›´æ–°æµç•…
- [ ] é”™è¯¯ä¸å½±å“å…¶ä»–ä¸Šä¼ 
- [ ] ç½‘ç»œæ…¢æ—¶ä¸ä¼šè¶…æ—¶

### è¾¹ç•Œæµ‹è¯•
- [ ] ç½‘ç»œæ–­å¼€æ—¶çš„å¤„ç†
- [ ] æœåŠ¡å™¨é™æµæ—¶çš„å¤„ç†
- [ ] å•ä¸ªæ–‡ä»¶å¤±è´¥ä¸å½±å“å…¶ä»–
- [ ] å–æ¶ˆæ“ä½œæ­£ç¡®åœæ­¢

---

## ğŸ’¡ æœ€ä½³å®è·µ

### é€‰æ‹©åˆé€‚çš„å¹¶å‘æ•°

```dart
// æ ¹æ®åœºæ™¯è°ƒæ•´
final concurrencyLimit = 
  // å±€åŸŸç½‘/å†…ç½‘
  isLocalNetwork ? 10 :
  
  // ç§»åŠ¨ç½‘ç»œ
  isMobileNetwork ? 3 :
  
  // é»˜è®¤ï¼ˆæ™®é€šå®½å¸¦ï¼‰
  5;
```

### é”™è¯¯å¤„ç†

```dart
try {
  await uploadEmote(entry);
} catch (e) {
  // âœ… è®°å½•é”™è¯¯ä½†ç»§ç»­
  Logs().d('Upload failed: $e');
  // ä¸è¦ rethrowï¼Œè®©å…¶ä»–ä¸Šä¼ ç»§ç»­
}
```

### è¿›åº¦æ›´æ–°

```dart
// âœ… ä½¿ç”¨ finally ç¡®ä¿è¿›åº¦æ€»æ˜¯æ›´æ–°
try {
  await uploadEmote(entry);
} catch (e) {
  // å¤„ç†é”™è¯¯
} finally {
  // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½æ›´æ–°è¿›åº¦
  updateProgress();
}
```

---

## ğŸ“ˆ æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. è‡ªé€‚åº”å¹¶å‘æ•°
```dart
// æ ¹æ®ç½‘ç»œé€Ÿåº¦è‡ªåŠ¨è°ƒæ•´
if (uploadSpeed > 5MB/s) {
  concurrencyLimit = 10;
} else if (uploadSpeed < 1MB/s) {
  concurrencyLimit = 3;
}
```

### 2. æ–­ç‚¹ç»­ä¼ 
```dart
// ä¿å­˜å·²ä¸Šä¼ åˆ—è¡¨
await saveProgress(uploadedEmotes);

// ä¸‹æ¬¡ç»§ç»­
final remaining = allEmotes.except(uploadedEmotes);
```

### 3. åå°ä¸Šä¼ 
```dart
// ä¸Šä¼ æ—¶å¯ä»¥å…³é—­å¯¹è¯æ¡†
await startBackgroundUpload(emotes);
showNotification("æ­£åœ¨åå°ä¸Šä¼ è¡¨æƒ…...");
```

### 4. æ™ºèƒ½é‡è¯•
```dart
// å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
for (var retry = 0; retry < 3; retry++) {
  try {
    await uploadEmote(entry);
    break;
  } catch (e) {
    if (retry == 2) rethrow;
    await Future.delayed(Duration(seconds: retry + 1));
  }
}
```

---

## âœ… ä¼˜åŒ–æ€»ç»“

### æ€§èƒ½æå‡

| æŒ‡æ ‡ | æå‡ |
|------|------|
| ä¸Šä¼ é€Ÿåº¦ | **5å€** |
| 10ä¸ªè¡¨æƒ… | 7ç§’ â†’ **1.5ç§’** |
| 50ä¸ªè¡¨æƒ… | 35ç§’ â†’ **7ç§’** |
| 100ä¸ªè¡¨æƒ… | 70ç§’ â†’ **14ç§’** |

### ç”¨æˆ·åé¦ˆé¢„æœŸ

```
ä¹‹å‰: "åŠ è½½è€—æ—¶å¤ªä¹…äº†å•Šï¼ğŸ˜¤"
ç°åœ¨: "å“‡ï¼Œå¥½å¿«ï¼ğŸ˜Š"
```

### æŠ€æœ¯ç‰¹ç‚¹

- âœ… å¹¶å‘ä¸Šä¼ ï¼ˆ5ä¸ª/æ‰¹ï¼‰
- âœ… æµç•…è¿›åº¦æ›´æ–°
- âœ… é”™è¯¯ä¸å½±å“å…¶ä»–
- âœ… å……åˆ†åˆ©ç”¨å¸¦å®½
- âœ… ä¸ä¼šè¿‡è½½æœåŠ¡å™¨

---

## ğŸš€ ç«‹å³ä½“éªŒ

```bash
cd /home/steve/Documents/fluffychat
flutter run -d linux

# æµ‹è¯•æ€§èƒ½
1. å‡†å¤‡ 20-50 ä¸ªè¡¨æƒ…å›¾ç‰‡
2. æ‰“åŒ…æˆ zip æˆ– tar.gz
3. å¯¼å…¥å¹¶è§‚å¯Ÿé€Ÿåº¦
4. æ„Ÿå— 5å€é€Ÿåº¦æå‡ï¼
```

**ä¸å†æ˜¯æ‡’è™«äº†ï¼** ğŸš€ğŸ’¨
